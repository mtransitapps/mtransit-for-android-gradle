name: MT SYNC CODE & DATA # download & paser
on: workflow_dispatch # manual
# gh workflow run mt-sync-code-data.yml --ref mmathieum
# gh run list --workflow=mt-sync-code-data.yml
jobs:
  MT-SYNC-CODE-DATA-JOB:
    runs-on: ubuntu-latest
    steps:
      - name: MT check out main repository code (no submodules)
        uses: actions/checkout@v2
        with:
          submodules: false
      - name: MT check out submodules
        run: ./checkout_submodules.sh
      # - name: List files in the repository
      #   run: |
      #     ls ${{ github.workspace }}
  # MT-SETUP-CODE:
  #   runs-on: ubuntu-latest
  #   needs: MT-SETUP-GIT
    # steps:
    #   - name: List files in the repository
    #     run: |
    #       ls ${{ github.workspace }}
      - name: MT code sync
        # TODO if ....
        run: |
        git submodule foreach git checkout ${{ env.BRANCH_NAME }}
        git submodule foreach git pull
      - name: MT code setup
        run: ./commons/code_setup.sh
        # run: "${GITHUB_WORKSPACE}/commons/code_setup.sh"
        # run:  |
        #   chmod +x ./commons/code_setup.sh
        #   ./commons/code_setup.sh
        # shell: bash
        # run: bash ./commons/code_setup.sh
  # MT-SETUP-DEPENDENCIES:
  #   runs-on: ubuntu-latest
  #   needs:  MT-SETUP-CODE
  #   steps:
      - name: MT set up JDK 11
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt-hotspot' # 'adopt'
          java-version: '11'
      - name: MT cache > Gradle wrapper
        uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/wrapper
          key: gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-wrapper-${{ hashFiles('gradle/wrapper/gradle-wrapper.properties') }}
      - name: MT Gradle cache > Generate key
        run: ./init_cache_key.sh
      - name: MT cache > Gradle cache
        uses: actions/cache@v2
        with:
          path: |
            ~/.gradle/caches
          key: gradle-cache-${{ hashFiles('gradle_cache_key_checksum.txt') }}
          restore-keys: |
            gradle-cache-${{ hashFiles('gradle_cache_key_checksum.txt') }}
            gradle-cache- # fallback to using the latest cache if no exact match is found
      - name: MT download dependencies
        run: ./gradlew androidDependencies --no-daemon --no-parallel --no-configure-on-demand --max-workers=1 --console=plain
      # - name: MT sync code
      #   # TODO if: true
      #   run: ./commons/code_sync.sh
      # TODO? - name: MT sync code commit
      #   run: |
      #   git submodule foreach git add .
      #   git submodule foreach git commit -m "CI: Code Sync"
      #   git add .
      #   git git commit -m "CI: Code Sync"
      - name: MT build & test
        run: ./build_and_test.sh
      - name: DEBUG List files in the repository
        run: |
          ls ${{ github.workspace }}
